name: CI/CD - Build, Push, and Deploy

on:
  push:
    branches: ["main"]

jobs:
  # This is the CI Job - It builds and pushes the image
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t mayanksdhamii/webstatus-checker:latest .
          docker push mayanksdhamii/webstatus-checker:latest

  # This is the new CD Job - It deploys the image to the server
  deploy:
    # This job will only run if the 'build-and-push' job succeeds
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2 instance
        # This is a popular marketplace action for SSH
        uses: appleboy/ssh-action@master
        with:
          # Use the public IP of your EC2 instance
          host: 13.201.93.246
          # The username for Amazon Linux
          username: ec2-user
          # The private key we stored in GitHub Secrets
          key: ${{ secrets.EC2_SSH_KEY }}
          # The commands to run on the server
          script: |
            # Pull the latest version of the image from Docker Hub
            docker pull mayanksdhamii/webstatus-checker:latest

            # Stop the currently running container (if it exists)
            # '|| true' ensures the command doesn't fail if the container isn't running
            docker stop my-cloud-checker || true

            # Remove the old container
            docker rm my-cloud-checker || true

            # Run the new container with the updated image
            docker run -d -p 80:80 --restart always --name my-cloud-checker mayanksdhamii/webstatus-checker:latest
